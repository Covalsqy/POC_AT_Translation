<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Translating...</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 900px; margin: 2rem auto; padding: 1rem; }
      .status { font-size: 1.1rem; font-weight: bold; margin: 1rem 0; }
      .progress-bar { 
        width: 100%; 
        height: 30px; 
        background: #e0e0e0; 
        border-radius: 5px; 
        overflow: hidden;
        margin: 1rem 0;
      }
      .progress-fill { 
        height: 100%; 
        background: linear-gradient(90deg, #4caf50, #2e7d32); 
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }
      .current-block {
        background: #f5f5f5;
        padding: 0.5rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9rem;
        margin: 1rem 0;
        color: #555;
      }
      .error { color: red; }
      .success { color: green; }
      textarea { width: 100%; height: 380px; font-family: monospace; font-size: 0.9rem; }
      .quality-score-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .quality-score-container h3 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.2rem;
      }
      .quality-display {
        display: flex;
        align-items: center;
        gap: 2rem;
      }
      .quality-score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      .quality-score-value {
        font-size: 2.5rem;
        font-weight: bold;
        line-height: 1;
      }
      .quality-score-max {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.25rem;
      }
      .quality-details {
        flex: 1;
      }
      .quality-level {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      .quality-description {
        font-size: 1rem;
        color: #555;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <h1>Translating PDF...</h1>
    <div class="status" id="statusText">Initializing...</div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%">
        <span id="progressPercent">0%</span>
      </div>
    </div>

    <div class="current-block">
      <strong>Current block:</strong>
      <div id="currentBlockText">Waiting...</div>
    </div>

    <div id="resultContainer" style="display:none; margin-top: 1rem;">
      <p>
        <a href="#" id="downloadLink" style="display:inline-block; padding:.4rem .8rem; background:#2b7; color:white; border-radius:4px; text-decoration:none;">Download .txt</a>
        <a href="/" style="margin-left:1rem;">Translate another</a>
      </p>
      
      <!-- Quality Score Section -->
      <div class="quality-score-container" id="qualityContainer" style="display:none;">
        <h3>ðŸ“Š Translation Quality Assessment</h3>
        <div class="quality-display">
          <div class="quality-score-circle" id="qualityCircle">
            <div class="quality-score-value" id="qualityScoreValue">--</div>
            <div class="quality-score-max">/100</div>
          </div>
          <div class="quality-details">
            <div class="quality-level" id="qualityLevel">--</div>
            <div class="quality-description" id="qualityDescription">Evaluating translation quality...</div>
          </div>
        </div>
      </div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div>
          <h3>Original</h3>
          <textarea readonly id="originalText"></textarea>
        </div>
        <div>
          <h3>Translated</h3>
          <textarea readonly id="resultText"></textarea>
        </div>
      </div>
    </div>

    <script>
      const pollInterval = 500;
      function poll() {
        fetch('/progress')
          .then(r => r.json())
          .then(data => {
            const { active, progress, result, original, download_url, error, quality_score } = data;
            const { current_batch, total_batches, current_text } = progress || {};

            if (error) {
              document.getElementById('statusText').innerHTML = `<span class="error">Error: ${error}</span>`;
              document.getElementById('progressFill').style.width = '0%';
              return;
            }

            if (total_batches > 0) {
              const percent = Math.round((current_batch / total_batches) * 100);
              document.getElementById('statusText').textContent = `Translating: ${current_batch} / ${total_batches} blocks`;
              document.getElementById('progressFill').style.width = percent + '%';
              document.getElementById('progressPercent').textContent = percent + '%';
              
              if (current_text) {
                document.getElementById('currentBlockText').textContent = current_text;
              }
            } else {
              document.getElementById('statusText').textContent = 'Loading model...';
              document.getElementById('progressFill').style.width = '0%';
              document.getElementById('currentBlockText').textContent = 'Initializing...';
            }

            if (!active && result) {
              document.getElementById('resultContainer').style.display = 'block';
              document.getElementById('originalText').value = original || "";
              document.getElementById('resultText').value = result || "";
              document.getElementById('downloadLink').href = download_url || "#";
              document.getElementById('statusText').innerHTML = '<span class="success">Translation complete!</span>';
              document.getElementById('progressFill').style.width = '100%';
              document.getElementById('progressPercent').textContent = '100%';
              document.getElementById('currentBlockText').textContent = 'Done!';
              
              // Display quality score if available
              if (quality_score) {
                document.getElementById('qualityContainer').style.display = 'block';
                document.getElementById('qualityScoreValue').textContent = quality_score.score.toFixed(1);
                document.getElementById('qualityLevel').textContent = quality_score.level;
                document.getElementById('qualityDescription').textContent = quality_score.description;
                
                // Set color based on quality level
                const scoreCircle = document.getElementById('qualityCircle');
                scoreCircle.style.borderLeft = `8px solid ${quality_score.color}`;
                
                const levelElement = document.getElementById('qualityLevel');
                levelElement.style.color = quality_score.color;
              }
              
              return;
            }

            if (active) setTimeout(poll, pollInterval);
          })
          .catch(() => setTimeout(poll, pollInterval));
      }
      poll();
    </script>
  </body>
</html>